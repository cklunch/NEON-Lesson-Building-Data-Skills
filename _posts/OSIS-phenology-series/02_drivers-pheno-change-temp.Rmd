---
layout: post
title: "Temperature as a Driver of Phenological Change"
date: 2016-04-01
authors: [Lee Stanish, Megan A. Jones]
contributors: [ ] 
dateCreated: 2016-01-01
packagesLibraries: [dplyr, ggplot2]
category: [self-paced-tutorial]
tags: [ ]
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
mainTag: 
tutorialSeries: [neon-pheno-temp-series]
description: "This tutorial discusses common drivers of phenological change. And
then demonstrates how to load and use NEON triple-asperated temperature data. 
Specific tasks include conversion to POSIX date/time class, subsetting by date, 
and plotting the data."
code1: 
image:
  feature: lidar_GrandMesa.png
  credit: LiDAR data collected over Grand Mesa, Colorado - National Ecological Observatory Network (NEON)
  creditlink: 
permalink: /R/neon-temp-phenology/
comments: true
---

{% include _toc.html %}

**R Skill Level:** Intermediate - you've got the basics of `R` down.

<div id="objectives" markdown="1">

###Goals / Objectives
After completing this activity, you will:

 * 

##Things Youâ€™ll Need To Complete This Tutorial
You will need the most current version of `R` and, preferably, `RStudio` loaded
on your computer to complete this tutorial.

###Install R Packages
* **ggplot2:** `install.packages("ggplot2")`
* **dplyr:** `install.packages("dplyr")`

[More on Packages in R - Adapted from Software Carpentry.]({{site.baseurl}}R/Packages-In-R/)

###Download Data 

{% include/dataSubsets/_data_NAME.html %}  

****
{% include/_greyBox-wd-rscript.html %}

****

##Additional Resources

</div>

## Drivers of phenology

Now that we see that there are differences in and shifts in phenophases, what 
are the drivers of phenophases?

Commonly studied drivers of phenophase change include:
	
* precipitation - how much rain/snow falls and the timing of the precipitation
* day length - day length effects the amount of sun the plants recieve and can 
use to photosynthesis and grow
* temperature - growth rates change depending on the temperature for different 
species

To continue our exploration of what might be a driver to the changes in
phenosphase that we saw in the previous tutorial, we will focus on temperature.


## NEON Temperature Data 

NEON collects XXX temperature at XXX intervals. Therefore, we could look at many
different temperature measures:

* near continuous temperature across the days
* aggregated data: min, mean, or max over a some duration
* the number of days since a freezing temperatures

Different species respond differently to the above measures. WHY high 
temperature is important to plant phenophase. 

Therefore, our research question going forward is: 

**How does the mean high temperature per day affect the phenophase?** 


## Import Data

This lesson uses 30 minute temperature data from the triple aspirated
temperature sensors mounted above the canopy on the NEON tower.

To set the working directory on the Mac, you need to first mount
the remote drive onto your computer

``` {r import-data}
# Set working directory

# setwd("/Volumes/TOS/OSIS_dataLessons/")
# (set wd for Megan's computer -others comment out - I can't get the Volumes to work) -
setwd("~/Documents/data/OSIS_dataLessons/")

# Load required libraries
library(ggplot2)
library(dplyr)

# why?
# site <- "HARV"

# Read in data
temp30 <- read.csv(file="temp_data/(paste("NEON.D01.", site, 
                ".DP1.00003.001.00000.000.060.030.TAAT_30min_teaching.csv"),
                sep="")", stringsAsFactors = FALSE, header=TRUE)

# alternate read in
temp30 <- read.csv(file="temp_data/NEON.D01.HARV.DP1.00003.001.00000.000.060.030.TAAT_30min_teaching.csv", stringsAsFactors = FALSE, header=TRUE)

```

## explore temp data - 
Now that you have the data, let's take a look at the readme and understand 
what's in the data. View readme and variables file. This will guide you
on how to import the data.

``` {r data-structure}
# Get a general feel for the data: View structure of data frame
str(temp30)
```

what is a QF. ->metadata
Check for Quality flags

``` {r qf-data}
# Review the data quality (are these data you trust?)
#1. Are there quality flags in your data? Count 'em up
  sum(temp30$finalQF==1)

```

Do we have NA data?
How to deal with? 

``` {r na-data}
# Are there NA's in your data? Count 'em up
sum(is.na(temp30$tempTripleMean) )

mean(temp30$tempTripleMean)
```

Why was there no output? 

We had previously seen that there are NA values in the temperature data. Given 
there are NA values, R, by default, won't calculate a mean (and many other 
summary statistics) as the NA values could skew the data. 

`na.rm=TRUE` #tells R to ignore them for calculaation,etc

```{r }
# create new dataframe without NAs
newDF <- na.omit(DF)  
```

Convert to correct time zone, default for this code is MST
 assign time zone to just the first entry
 
``` {r convert-date-time}

# View the date range
range(temp30$startDateTime)

temp30$startDateTime <- as.POSIXct(temp30$startDateTime,
format = "%Y-%m-%dT%H:%M", tz = "GMT")
# check that conversion worked
str(temp30$startDateTime)
```

Subset by date

``` {r subset-date}
# Limit dataset to dates of interest (4/1/2014-11/30/2014)
subset(temp30, )

```


## plot 30-min data over year 


## aggregate by day & find max ->  dplyr 

``` {r daily-max-dplyr}
dplyr groupby max

```

## Challenge (maybe) aggregate by mean daily or min daily


## plot daily max over year

To successfully plot, the last piece that is needed is the `geom`etry type. In 
this case, we want to create a scatterplot so we can add `+ geom_point()`.

Let's create an air temperature scatterplot. 

``` {r basic-ggplot2}
# plot Air Temperature Data across 2009-2011 using daily data
name <- ggplot(harMetDaily.09.11, aes(date, airt)) +
           geom_point(na.rm=TRUE)

```



### Set/Remove No Data Values

## Managing Missing Data: NoData values

### Find NoData Values

If we are lucky when working with external data, the `NoData` value is clearly
specified
in the metadata. No data values can be stored differently:

* **NA / nan:** Sometimes this value is `NA` or `nan` (not a number). 
* **A Designated Numeric Value (e.g. -9999):** Character strings such as `NA` can 
not always be stored along side of numeric values in some file formats. Sometimes 
you'll encounter numeric placeholders for `noData` values such as
`-9999` (a value often used in the GIS / Remote Sensing and Micrometerology 
domains.
* **Blank Values:** sometimes `noData` values are left blank. Blanks are 
particularly problematic because we can't be certain if a data value is 
purposefully missing (not measured that day or a bad measurement) or if someone 
unintentionally deleted it.

Because the actual value used to designate missing data can vary depending upon 
what data we are working with, it is important to always check the metadata for
the files associated `NoData` value. If the value is `NA`, we are in luck, `R`
will recognize and flag this value as `NoData`. If the value is numeric (e.g.,
`-9999`), then we might need to assign this value to `NA`.

<i class="fa fa-star"></i> **Data Tip:** `NA` values will be ignored when
performing calculations in `R`. However a `NoData` value of `-9999` will be
recognized as an integer and processed accordingly. If you encounter a numeric
`NoData` value be sure to assign it to `NA` in `R`:
`objectName[objectName==-9999] <- NA`
{: .notice}

In the
[Why Metadata Are Important: How to Work with Metadata in Text & EML Format]({{ site.baseurl }}/R/why-metadata-are-important/)
we viewed the metadata for these data and discovered that missing values are
designated using `NA` - a common `NoData` value placeholder. 

>**Excerpt from the metadata:** `airt: average air temperature. Average of daily 
>averages. (unit: celsius, missing value: NA)`


### Check For NoData Values  

We can quickly check for `NoData` values in our data using the`is.na()` 
function. By asking for the `sum()` of `is.na()` we can see how many NA/ missing
values we have. 

```{r missing values}

# Check for NA values
sum(is.na(phe_ind$date))
sum(is.na(phe_ind$individualID))

```

The results above tell us there are `NoData` values in the `datetime` column.
However, there are `NoData` values in other variables.  

<div id="challenge" markdown="1">

### Deal with NoData Values
When we encounter `NoData` values (blank, NaN, -9999, etc.) in our data we
need to decide how to deal with them. By default `R` treats `NoData` values
designated with a `NA` as a missing value rather than a zero. This is good, as a
value of zero (no rain today) is not the same as missing data (e.g. we didn't
measure the amount of rainfall today). 

How we deal with `NoData` values will depend on:

* the data type we are working with
* the analysis we are conducting 
* the significance of the gap or missing value

Many functions in `R` contains a `na.rm=` option which will allow you to tell R
to ignore `NA` values in your data when performing calculations.

### To Gap Fill? Or Not?

Sometimes we might need to "gap fill" our data. This means we will interpolate 
or estimate missing values often using statistical methods. Gap filling can be 
complex and is beyond the scope of this tutorial. The take away from this
is simply that it is important to acknowledge missing values in your data and to 
carefully consider how you wish to account for them during analysis. 

Other resources:

1. R code for dealing with missing data: 
<a href="http://www.statmethods.net/input/missingdata.html" target="_blank"> Quick-R: Missing Data</a> 
 
2. The Institute for Digital Research and Education has an 
<a href="http://www.ats.ucla.edu/stat/r/faq/missing.htm" target="_blank"> R FAQ on Missing Values</a>.

### Managing NoData Values in Our Data
For this tutorial, we are exploring the patterns of precipitation,
and temperature as they relate to green-up and brown-down of vegetation at 
Harvard Forest. To view overall trends during these early exploration stages, it 
is okay for us to leave out the `NoData` values in our plots. 

<i class="fa fa-star"></i> **Data Tip:** If we wanted to perform more advanced 
statistical analysis, we might consider gap-filling as our next step. Many data 
products, from towers such as FluxNet include a higher level, gap-filled
product that we can download. 
<a href="http://www.archive.arm.gov/Carbon/gapfilling/gapfilling.html"
target="_blank">More on Gap Filling</a>
{: .notice}

### NoData Values Can Impact Calculations
It is important to consider `NoData` values when performing calculations on our
data. For example, `R` will not properly calculate certain functions if there
are `NA` values in the data, unless we explicitly tell it to ignore them. 

``` {r na-in-calculations}

# calculate mean of air temperature
mean(harMet15.09.11$airt)

# are there NA values in our data?
sum(is.na(harMet15.09.11$airt))

```

`R` will not return a value for the mean as there `NA` values in the air 
temperature column. Because there are only 2 missing values (out of 105,108) for 
air temperature, we aren't that worried about a skewed 3 year mean. We can tell 
`R` to ignore noData values in the mean calculations using `na.rm=`
(NA.remove).

``` {r na-rm}
# calculate mean of air temperature, ignore NA values
mean(harMet15.09.11$airt, 
     na.rm=TRUE)

```

